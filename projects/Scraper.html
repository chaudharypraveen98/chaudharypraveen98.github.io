<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="A scraper script which is running on python's framework Flask and Fast Api can scrape BoxOfficeMojo website." />
        <title>Scraper</title><meta name="description" content="This contains all the projects made by Praveen chaudhary">
        <meta name="keywords" content="chaudharypraveen98,Praveen Chaudhary,devilunknown, Praveen Chaudhary projects, Scraper">
        <meta name="robots" content="index, follow">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="language" content="English">
        <meta name="revisit-after" content="2 days">
        <meta name="author" content="@chaudharypraveen98">
        <meta name="twitter:title" content="Praveen Chaudhary">
        <meta name="twitter:description" content=" Personal Projects Section">
        <meta name="twitter:image" content="https://pbs.twimg.com/profile_images/1366311960468332546/EidYygUt_400x400.jpg">
        <meta name="twitter:card" content="summary_large_image">
        <meta property="og:title" content="Praveen Chaudhary - a Full Stack Developer" />
        <meta property="og:url" content="https://www.linkedin.com/in/chaudharypraveen98/" />
        <meta property="og:description" content="This is the personal portfolio page which contains all the projects. I am a Full Stack Developer, Rest Api Developer, Data Analsyt" />
        <meta property="og:image" content="https://media-exp1.licdn.com/dms/image/C5603AQHRamUaMrdA9g/profile-displayphoto-shrink_400_400/0/1597315489941?e=1629936000&v=beta&t=GjvQu_r0n3F2EtGkaRYSF6pH8vRdgx5lsD1-w8dc8gY" />
        <meta property="og:type" content="Portfolio.Projects" />
        <link rel="shortcut icon" href="./../favicon.ico" type="image/x-icon">
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">Scraper</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="https://chaudharypraveen98.github.io/about.html">About</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="https://chaudharypraveen98.github.io/project-preview/">Latest Works</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="https://chaudharypraveen98.github.io/contact.html">Contact</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Page Header-->
        <header class="masthead" style="background-image: url('assets/img/post-bg.jpg')">
            <div class="container position-relative px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="post-heading">
                            <h1>Scraper</h1>
                            <h2 class="subheading">A scraper script which is running on python's framework Flask and Fast Api can scrape BoxOfficeMojo website.</h2>
                            <span class="meta">
                                Posted by
                                <a href="https://github.com/chaudharypraveen98">Praveen Chaudhary</a>
                                on 13 June 2020
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Post Content-->
        <article class="mb-4">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <h3>Topics -> fastapi, flask, script, requestsHTML, pandas, scraping, cli</h3>
                        <h5>Preview Link -> <u><a href="https://drive.google.com/file/d/1qldZHgiE9xDCtJZXJ7RcH5DsaE2xh1w2/preview">Scraper</a></u></h5>
                        <h5>Source Code Link -> <u><a href="https://github.com/chaudharypraveen98/Scraper">GitHub</a></u></h5>
                        <iframe src="https://drive.google.com/file/d/1qldZHgiE9xDCtJZXJ7RcH5DsaE2xh1w2/preview" width="640" height="480" allow="autoplay"></iframe>
                        <p><strong>What We are going to do?</strong></p>
                        <ol>
                          <li>We are creating a script to scrape the BoxOfficeMojo and export it to excel using the pandas library by making Dataframe using the nested dictionary.</li>
                          <li>Then, setting up the Flask Server to run periodic scraping using the get request on a particular url endpoint after a certain interval of time.</li>
                          <li>Then, making a url endpoint to serve the data which we had scraped till now.</li>
                          <li>We are making our localhost server accessible from anywhere using the Ngrok.</li>
                          <li>Lastly, We are making a cmdlet or powershell script to run from anywhere wether command prompt or window power shell.</li>
                        </ol>
                        <h2 class="section-heading">Step 1 -> Writing scraper and exporting data (Scraper.py)</h2>
                        <p><h3>Writing scraper</h3></p>
                        <p>We will use requestsHTML to scrape the data with the help of css selectors.</p>
                        <p><strong>But, What are selectors/locators?</strong></p>
                        <p>A CSS Selector is a combination of an element selector and a value which identifies the web element within a web page.</p>
                        <p><b>The choice of locator depends largely on your Application Under Test</b></p>
                        <b>Id</b>
                        <p>An element’s id in XPATH is defined using: “[@id='example']” and in CSS using: “#” - ID's must be unique within the DOM.</p>
                        <p>Examples:</p>
                        <pre>
XPath: //div[@id='example']
CSS: #example
                      </pre>
                      <p><b>Element Type</b></p>
                       <p>The previous example showed //div in the xpath. That is the element type, which could be input for a text box or button, img for an image, or "a" for a link. </p>
                        
                        <pre>
Xpath: //input or
Css: =input
                      </pre>
                      <p><b>Direct Child</b></p>
                        <p>HTML pages are structured like XML, with children nested inside of parents. If you can locate, for example, the first link within a div, you can construct a string to reach it. A direct child in XPATH is defined by the use of a “/“, while on CSS, it’s defined using “>”. </p>
                        <p>Examples:</p>
                        <pre>                        
XPath: //div/a
CSS: div > a
                      </pre>
                      <p><b>Child or Sub-Child</b></p>
                        <p>Writing nested divs can get tiring - and result in code that is brittle. Sometimes you expect the code to change, or want to skip layers. If an element could be inside another or one of its children, it’s defined in XPATH using “//” and in CSS just by a whitespace.</p>
                        <p>Examples:</p>
                        <pre>
                        
XPath: //div//a
CSS: div a
                      </pre>
                      <p><b>Class</b></p>
                        <p>For classes, things are pretty similar in XPATH: “[@class='example']” while in CSS it’s just “.” </p>
                        <p>Examples:</p>
                        <pre>
XPath: //div[@class='example']
CSS: .example
                        </pre>

                        <p><strong>Libraries Required :-</strong></p>
                        <ol>
                          <li>Request-html</li>
                          <li>Requests</li>
                          <li>Pandas</li>
                        </ol>

                        <p><strong>So, How to install them ?</strong></p>
                        <p>Run the following commands in python shell</p>
                        <pre>
pip install requests-html
pip install requests
pip install pandas
                        </pre>

                        <p><strong>Getting the html code using the Requests library</strong></p>
                        <p>It will take the filename as the keyword argument if save data is true. By default it will not save the html code in a file.</p>
                        <p>We are making a get request then we check for the response  status code. if status_code is in range(200,299) then its Ok.</p>
                        <p>Then the html code is feed into <tt>pharse_and_extract</tt> function</p>
                        <pre>
def url_to_text(url, filename="world.html", save=False):
    r = requests.get(url)
    if r.status_code == 200:
        html_text = r.text
        if save:
            with open(filename, 'w') as f:
                f.write(html_text)
        return html_text
    return None
                        </pre>

                        <p><strong>Html Parsing</strong></p>
                        <p>The response code is parsed into html code using the requestsHTML HTML parser.</p>
                        <pre>
def pharse_and_extract(url, name=2020):
    html_text = url_to_text(url)
    if html_text is None:
        return ""
    r_html = HTML(html=html_text)
                        </pre>

                        <p><strong>Scraping</strong></p>
                        <p>We will use the css selectors to locate the element and get the required data.</p>
                        <pre>
def pharse_and_extract(url, name=2020):
    html_text = url_to_text(url)
    if html_text is None:
        return ""
    r_html = HTML(html=html_text)

    # scraping starts from here

    table_class = ".imdb-scroll-table"
    r_table = r_html.find(table_class)
    table_data = []

    if len(r_table) == 1:
        table = r_table[0]
        header_col = table.find("th")
        header_names = [x.text for x in header_col]
        rows = table.find("tr")
        for row in rows[1:]:
            cols = row.find("td")
            row_data = []
            for i, col in enumerate(cols):
                row_data.append(col.text)
            table_data.append(row_data)
                        </pre>

                        <p><strong>Exporting into CSV file</strong></p>
                        <p>Once the data is scraped, then it is loaded into Pandas Dataframe and then exported into CSV file.</p>
                        <pre>
def pharse_and_extract(url, name=2020):
    html_text = url_to_text(url)
    if html_text is None:
        return ""
    r_html = HTML(html=html_text)
    table_class = ".imdb-scroll-table"
    r_table = r_html.find(table_class)
    table_data = []

    if len(r_table) == 1:
        table = r_table[0]
        header_col = table.find("th")
        header_names = [x.text for x in header_col]
        rows = table.find("tr")
        for row in rows[1:]:
            cols = row.find("td")
            row_data = []
            for i, col in enumerate(cols):
                row_data.append(col.text)
            table_data.append(row_data)

    # exporting data starts from here
    
    path = os.path.join(BASE_DIR, 'data')
    os.makedirs(path, exist_ok=True)
    filepath = os.path.join('data', f'{name}.csv')

    # loading into dataframe
    df = pd.DataFrame(table_data, columns=header_names)
    df.to_csv(filepath, index=False)
                        </pre>

                        <h2 class="section-heading">Step 2 -> Setting up Flask Server</h2>
                        <p>We are making a url endpoint, so that we can set up periodic scraping through a post request.</p>
                        <pre>
from flask import Flask
from scraper import run as scraper_runner
from logger import log_save

app = Flask(__name__)

@app.route("/box-office", methods=['POST'])
def box_office_view():
    log_save()
    scraper_runner()
    return "done"
                        </pre>
                        <h2 class="section-heading">Step 3 -> Serving the scraped data using FastAPI</h2>
                        <p>we will load the data into dataframe from a csv file and then return a dictionary data to the forntend</p>
                        <pre>
from fastapi import FastAPI
from scraper import run as scraper_runner
from logger import log_save
import os
import pandas as pd

app = FastAPI()

# Getting the file location

current = (os.path.join(os.getcwd(), 'data'))
os.makedirs(current, exist_ok=True)
file = os.path.join(current, "box_office_cleaned.csv")

# Serving the file on a get request

@app.get("/box-office-collect")
def abc():
    df = pd.read_csv(file)
    return df.to_dict("Rank")

                        </pre>
                        <p>We can even setup periodic scraping in FastAPI too by simple command given below -:</p>
                        <pre>
                            @app.post("/box-office")
def box_office():
    log_save()
    scraper_runner()
    return {"data": "success"}

                        </pre>
                        <h2 class="section-heading">Step 4 -> Deployment</h2>
                        <p>For deployment,  We are using the <strong>Ngrok</strong> to deploy our localhost to web.<span><a href="https://ngrok.com/">For More Info</a></span></p>
                        <p>Make a python file (trigger.py)</p>
                        <p>Once our flask server is exposed through ngrok then we can make a post request to make a periodic scraping. We can use tools for that purpose like :-</p>
                        <ol>
                            <li>UptimeRobot</li>
                            <li>Freshworks</li>
                            <li>Uptrends</li>
                        </ol>
                        <pre>
import requests

url = "http://9d44e5091b7d.ngrok.io"
endpoint = f'{url}/box-office'
r = requests.post(endpoint, json={})
print(r.text)
                            
                        </pre>
                        
                        <h2 class="section-heading">Step 5 -> Making a ps1 script</h2>
                        <p>It will help us to run command from anywhere like cmd, powershell etc</p>
                    
                        <b>Make a file with ps1 extension</b>
                        <p><strong>For Flask Server</strong></p>
                        <pre>
set FLASK_APP=flask_server.py
$env:FLASK_APP = "flask_server.py"
flask run --host=127.0.0.1 --port=8000
                        </pre>

                        <p><strong>For FastAPI Server</strong></p>
                        <pre>
uvicorn fast_server:app --port 8888
                        </pre>

                        <h2 class="section-heading">Web Preview / Output</h2>
                        <a href="https://raw.githubusercontent.com/chaudharypraveen98/Scraper/master/output.JPG"><img class="img-fluid" src="https://raw.githubusercontent.com/chaudharypraveen98/Scraper/master/output.JPG" alt="web preview" /></a>
                        <span class="caption text-muted">Web preview on deployment</span>
                        <p>
                            Placeholder text by
                            <a href="https://chaudharypraveen98.github.io/">Praveen Chaudhary</a>
                            &middot; Images by
                            <a href="hhttps://chaudharypraveen98.github.io/binarybeast/">Binary Beast</a>
                        </p>
                    </div>
                </div>
            </div>
        </article>
        <!-- Footer-->
        <footer class="border-top">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <ul class="list-inline text-center">
                            <li class="list-inline-item">
                                <a href="https://twitter.com/chaudhpraveen98">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="https://www.linkedin.com/in/chaudharypraveen98/">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="https://github.com/chaudharypraveen98">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                        </ul>
                        <div class="small text-center text-muted fst-italic">Copyright &copy; Praveen Chaudhary 2021</div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
